\section{Modules, Hostgroups and Environments}

The Puppet infrastructure at CERN is based on three different components
that we will describe in this section: Modules, Hostgroups and
Environments.

It is important to keep in mind that all those components are stored in
separate Git repositories in order to keep track of code changes and make
the configuration change process easy and trackable. Using a versioning
control software makes all the changes trackable and, at the same time,
makes easy to roll back in case of errors or problems. Moreover, two or
more user can work on the same code in parallel to solve different issues
at the same time, improving the time to delivery.

Every repository has at least two branches: \textbf{master} and
\textbf{qa}. The code in 'master' will target all the machines in
production, while the code in 'qa' will target all the QA machines, that
are used to test the code changes before merging them into production.
Users can test their changes in custom branches and merge them later,
following the procedure that we will see later, when they feel their
change is ready for deployment.

\subsection{Modules}

Puppet modules are used to configure a single service/software on a server
and they can be reused across different hostgroups. Modules can be seen as
re-usable puppet code, they are a sort of libraries in the puppet world.
Each installation can be customized in the puppet manifest using tunable
parameters.

There are different types of modules in the CERN database, the most
important ones are the so called \textit{base modules}. These modules are
used in all the servers that are deployed using Puppet and the procedure
to change them includes additional checks since a problem might lead to
a large scale failure. A change in the base modules affects nearly every
server in the data centre.

Most of the modules are downloaded from a public modules store called
\textit{PuppetForge} where users can upload their modules, share them with the
community and receive improvements on their code. Most of these public modules
are hosted on Github and the team tries to keep them in sync with the local
copy that is stored at CERN. It happens often that a module can not be imported
out of the box into the CERN repositories since they need a particular set of
configuration. The team is also trying to give back their contributions
improving the code back to the community but that is not always an easy task to
accomplish.

\subsection{Hostgroups}

At CERN we define hostgroup a group of servers that are part of the same
service. They contain the Puppet code to configure and run a set of
machines, using modules to configure the services. Usually a group of
nodes has the same hostgroup if:

\begin{itemize}

\item The nodes are all part of the same service

\item The nodes have some configuration in common

\item The nodes are managed by the same group of people

\end{itemize}

It is also possible to define sub-hostgroups, to split the functionalities
of the nodes within the service. Since the hostgroup structure is
hierarchical a node in a sub-hostgroup inherits the settings from all this
parents. For example: \newline{} 

\begin{table}[H]
    \begin{center}
    \begin{tabular}{|l|c|}
        \hline
        \textbf{Hostgroup} & \textbf{Purpose} \\
        \hline
        web & is the top-level hostgroup for the Web service \\
        \hline
        web/prod & is the hostgrup containing the nodes of the production instance \\
        \hline
        web/prod/balance & are the Apache balancer nodes in front of the production service \\
        \hline
    \end{tabular}
    \end{center}
\end{table}

In this way service managers can organize their service in a better way,
creating smaller clusters within the same hostgroup.

\subsection{Environments}

Environments are collections of modules and hostgroups at different
development levels, based on their Git history; they are defined in YAML
\cite{YAMLWebsite} files living in a Git repository. Jens uses those files
to create the custom environments that are served to the puppet masters.

There are two golden environments:

\begin{itemize}
    \item \textbf{production} - modules and hostgroup are cloned from the master branch of
their git repositories
    \item \textbf{qa} - modules and hostgroups are cloned from the qa branch of their git
repositories
\end{itemize}

Moreover there are a set of custom defined environments mainly used for
testing purpose: they allow service managers to override some modules and
specify a different branch from the default one.

There are two different types of environments:

\begin{itemize} 
    \item Dynamic environments

Service managers can specify a default branch for hostgroup and modules
(usually master or qa) and override others. For example:

\begin{lstlisting}[language=bash, frame=single]
default: qa
notifications: john.doe@cern.ch
overrides:
    modules:
        sssd: ai456
\end{lstlisting}

    \item Static environments (Snapshots) 
    
These environments are completely static, every module and hostgroup
points to a specific git commit: the configuration won't be updated
without a manual intervention on the environment file. For example:

\begin{lstlisting}[language=bash, frame=single]
notifications: john.doe@cern.ch
overrides:
    common:
        hieradata: commit/fb96070c9c77cc442ac60ba27
        site: commit/fb96070c9c77cc442ac60ba27
    hostgroups:
        adcmon: commit/8bf3ca9fe39a6f354dfc70377
    [...]
\end{lstlisting}
\end{itemize}
